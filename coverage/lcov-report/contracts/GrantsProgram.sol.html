<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/GrantsProgram.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> GrantsProgram.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.33% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>42/45</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>18/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>10/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>46/46</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-yes">21×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">76×</span>
<span class="cline-any cline-yes">76×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">78×</span>
<span class="cline-any cline-yes">78×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-yes">77×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;
&nbsp;
import "./IBridge.sol";
import "./BytesLib.sol";
&nbsp;
contract GrantsProgram {
    event MemberEnabled(address indexed memberAddress);
    event MemberDisabled(address indexed memberAddress);
    event FundsReceived(uint256 amount);
    event FederatorPaid(address indexed fedAddress, uint256 amount);
    event NotEnoughFunds(uint256 amount);
    event LogWithdrawal(address sender);
&nbsp;
    mapping(address =&gt; bool) public bannedAddressesMap;
    uint256 public lastPaid;
    address public authorized;
    uint256 public periodLength;
    uint256 public amountToPay;
    mapping(address =&gt; uint256) public federatorLastPaid;
    IBridge public bridge;
&nbsp;
    constructor(address _authorized, uint256 _periodLength, uint256 _amountToPay, address _bridgeAddress) public {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_authorized != address(0), "GrantsProgram: Authorized address can't be null");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_periodLength != 0, "GrantsProgram: Period lenght must be greater than 0");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_amountToPay &gt; 0, "GrantsProgram: Amount to pay must be greater than 0");
&nbsp;
        authorized = _authorized;
        periodLength = _periodLength;
        amountToPay = _amountToPay;
        bridge = IBridge(_bridgeAddress);
    }
&nbsp;
    modifier onlyAuthorized() {
        require(msg.sender == authorized, "GrantsProgram: Not authorized");
        _;
    }
&nbsp;
    receive() external payable {
        emit FundsReceived(msg.value);
    }
&nbsp;
    function disableMember(address member) external onlyAuthorized {
        if (bannedAddressesMap[member] == false) {
            bannedAddressesMap[member] = true;
            emit MemberDisabled(member);
        }
    }
&nbsp;
    function enableMember(address member) external onlyAuthorized {
        if (bannedAddressesMap[member] == true) {
            delete bannedAddressesMap[member];
            emit MemberEnabled(member);
        }
    }
&nbsp;
    function getRequiredFunds() external view returns (uint256) {
        uint256 federationSize = bridge.getFederationSize();
        return federationSize * amountToPay;
    }
&nbsp;
    function payToFederation() external {
        require(address(this).balance &gt;= this.getRequiredFunds(), "GrantsProgram: Not enough funds for paying to all federators");
&nbsp;
        uint256 federationSize = bridge.getFederationSize();
&nbsp;
        for (uint256 i = 0; i &lt; federationSize; i++) {
            bytes memory fedPubKey = bridge.getFederatorPublicKeyOfType(i, "rsk");
            address payable fedAddress = getAddressFromPublicKey(fedPubKey);
&nbsp;
            if (!bannedAddressesMap[fedAddress] &amp;&amp; block.timestamp &gt;= federatorLastPaid[fedAddress] + periodLength) {
                fedAddress.transfer(amountToPay);
                federatorLastPaid[fedAddress] = block.timestamp;
                emit FederatorPaid(fedAddress, amountToPay);
            }
        }
    }
&nbsp;
    function getAddressFromPublicKey(bytes memory fedPubKey) public view returns (address payable) {
        bytes memory decompressedPublicKey = this.decompressPublicKey(fedPubKey);
        return payable(address(uint160(uint256(keccak256(abi.encodePacked(decompressedPublicKey))))));
    }
&nbsp;
    function withdrawFunds(address payable recoverAddress) external onlyAuthorized {
        recoverAddress.transfer(address(this).balance);
        emit LogWithdrawal(msg.sender);
    }
&nbsp;
    function decompressPublicKey(bytes memory fedPubKey) public pure returns (bytes memory) {
        uint8 firstByte = BytesLib.toUint8(fedPubKey, 0);
        require(firstByte == 2 || firstByte == 3, "GrantsProgram: Provided public key is not compressed");
        
        uint8 compressedPrefix = firstByte == 2 ? 0 : 1;
        uint256 x = BytesLib.toUint256(fedPubKey, 1);
        uint256 p = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F;
        uint256 y2 = addmod(mulmod(x, mulmod(x, x, p), p), 7, p);
        uint256 y_ = expmod(y2, (p + 1) / 4, p);
        uint256 cmp = compressedPrefix ^ (y_ &amp; 1);
        return abi.encodePacked(x, (cmp == 0) ? y_ : p - y_);
    }
&nbsp;
    function expmod(uint256 b, uint256 e, uint256 m) internal pure returns (uint256 r) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (b == 0) <span class="cstat-no" title="statement not covered" >return 0;</span>
        <span class="missing-if-branch" title="if path not taken" >I</span>if (e == 0) <span class="cstat-no" title="statement not covered" >return 1;</span>
        <span class="missing-if-branch" title="if path not taken" >I</span>if (m == 0) <span class="cstat-no" title="statement not covered" >revert()</span>;
        r = 1;
        uint256 bit = 2**255;
        assembly {
            for {} gt(bit, 0) {} {
                r := mulmod(mulmod(r, r, m),exp(b, iszero(iszero(and(e, bit)))),m)
                r := mulmod(mulmod(r, r, m), exp(b, iszero(iszero(and(e, div(bit, 2))))), m)
                r := mulmod(mulmod(r, r, m), exp(b, iszero(iszero(and(e, div(bit, 4))))), m)
                r := mulmod(mulmod(r, r, m), exp(b, iszero(iszero(and(e, div(bit, 8))))),m)
                bit := div(bit, 16)
            }
        }
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Jul 08 2020 15:02:19 GMT-0300 (-03)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
